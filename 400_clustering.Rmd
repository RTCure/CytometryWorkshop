---
title: "Cytometry Workflow 4 - Clustering"
output: 
    html_document:
        df_print: paged
        code_folding: show
        toc: yes
        toc_float: yes
        toc_depth: 4
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{r libraries}
library(targets)
```

# Globals

We first define some global options/functions common to all targets.

```{targets globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
tar_option_set(packages = c("tidyverse"))
source("scripts/900_functions.R")
```

# FlowSOM

On top of manual gating we use `FlowSOM` ([Van Gassen 2015](https://doi.org/10.1002/cyto.a.22625)). First we define the parameters:

 - the size of the grid (number of clusters)
 - the number of metaclusters to return
 - the channels to use for clustering
 
```{targets params-fsom}
list(
    tar_target(params_fsom_grid,6),
    tar_target(params_fsom_nclus,7),
    tar_target(params_fsom_channels,{
        with(markers,
             name[type %in% c("phenotypic")])
    })
)
```

Then we run the clustering algorithm:

```{targets live.fsom, tar_simple=TRUE}
library(FlowSOM)
.fs <- live.df %>%
    mutate(across(all_of(params_fsom_channels),
                  ~ do_shave(.x,
                             fun=function(x) quantile(x,
                                                      params_markers_lims)))) %>% 
    dplyr::select(all_of(params_fsom_channels)) %>% 
    as.matrix(.)

FlowSOM(.fs,
        compensate = FALSE,
        transform = FALSE,
        scale = FALSE,
        xdim = params_fsom_grid, 
        ydim = params_fsom_grid,
        colsToUse = params_fsom_channels,
        nClus = params_fsom_nclus)
```

Finally we extract the clusters and metaclusters to use in other analysis:

```{targets fsom-clusters}
list(
    tar_target(live.fsom.clusters,{
        live.fsom$map$mapping[,1]
    }),
    tar_target(live.fsom.metaclusters,{
        live.fsom$metaclustering[live.fsom.clusters]
    })
)
```

# Heatmaps

We will generate `ggplot2` heatmaps of channel intensity for clusters and metaclusters, to be used in different reports.

## Clusters

```{targets live.clusters.channels, tar_simple=TRUE}
.df <- live.df %>% 
    mutate(Population = live.fsom.clusters) %>% 
    select(all_of(c("Population",params_fsom_channels))) %>% 
    rename_with(~ with(markers,
                       desc[match(.x,name)]),
                !Population) %>% 
    gather("Channel","value",
           -Population) %>% 
    group_by(Population,Channel) %>% 
    summarize(value = median(value),
              .groups = "drop_last")

.mat <- .df %>% 
    spread(Channel,value)
.ids <- .mat[,1,drop=TRUE]
.mat <- as.matrix(.mat[,-1])
rownames(.mat) <- .ids
.hc.rows <- hclust(dist(.mat))
.hc.cols <- hclust(dist(t(.mat)))

.df %>% 
    mutate(Population = factor(Population,
                               levels = with(.hc.rows,labels[order])),
           Channel = factor(Channel,
                            levels = with(.hc.cols,labels[order])))
```

## Metaclusters

```{targets live.metas.channels, tar_simple=TRUE}
.df <- live.df %>% 
    mutate(Population = live.fsom.metaclusters) %>% 
    select(all_of(c("Population",params_fsom_channels))) %>% 
    rename_with(~ with(markers,
                       desc[match(.x,name)]),
                !Population) %>% 
    gather("Channel","value",
           -Population) %>% 
    group_by(Population,Channel) %>% 
    summarize(value = median(value),
              .groups = "drop_last")

.mat <- .df %>% 
    spread(Channel,value)
.ids <- .mat[,1,drop=TRUE]
.mat <- as.matrix(.mat[,-1])
rownames(.mat) <- .ids
.hc.rows <- hclust(dist(.mat))
.hc.cols <- hclust(dist(t(.mat)))

.df %>% 
    mutate(Population = factor(Population,
                               levels = with(.hc.rows,labels[order])),
           Channel = factor(Channel,
                            levels = with(.hc.cols,labels[order])))
```

# Minimum Spanning Tree

We extract the layout of the minimum spanning tree generated by `FlowSOM` on clusters

```{targets live.fsom.clusters.mst, tar_simple=TRUE}
.graph <- live.fsom$MST$graph
.graph$layout <- live.fsom$MST$l
.graph
```

# Render the `_clustering` report

We will reviewing the output of clustering in the `_clustering` report:

```{targets clustering-report}
tarchetypes::tar_render(clustering,
                        "reports/_clustering.Rmd",
                        params = list(store = tar_config_get("store")))
```

# Run the pipeline

```{r run}
tar_make()
```
