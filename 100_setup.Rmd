---
title: "Cytometry Workflow 1 - Preparing the data"
output: 
    html_document:
        df_print: paged
        code_folding: show
        toc: yes
        toc_float: yes
        toc_depth: 4
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{r}
library(targets)
# tar_unscript() # this line resets the whole pipeline!
```

# Globals

We first define some global options/functions common to all targets.

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
tar_option_set(packages = c(c("MASS","cluster",
                              "flowWorkspace","flowCore",
                              "hilbertSimilarity","entropy",
                              "Radviz","cytofan",
                              "lme4","emmeans",
                              "FlowSOM","Rtsne",
                              "yaml","tidyverse")))
source("scripts/900_functions.R")
```

# Parameters

We need to define:

 - the path to the `GatingSet` object to analyze
 - the full node path to the root population of interest
 - the list of markers corresponding to the different categories
     - *reference* markers that are part of the gating scheme and will be negative or positive for all cells
     - *phenotypic* markers that are differentiating populations within the population of interest (bimodal)
     - *functional* markers that are indicative of the status of the cells (continuous)
     - all other markers are considered *CyTOF*

```{targets params}
list(tar_target(params_path,
                file.path("process","workshop","live")),
     tar_target(params_population,
                "/Lymphocytes+Monocytes/Single Cells/live/CD3 subset, FSC-A"),
     tar_target(params_ref_markers,
                c('LIVE','CD14','CD3','CD8')),
     tar_target(params_pheno_markers,
                c('CD25','CD4','CD45RA','FOXP3','gd')),
     tar_target(params_func_markers,
                c('CCR6','CCR7','CD137','CD69','GMCSF','HLADR','IFNG','IL10',
                  'IL17A','IL1B','IL6','PRF1','TNF'))
)
```

# Sample annotation

Sample annotation can be either parsed from FCS file names (as below) or loaded from a file; is **must** include at least a `name` column corresponding to the FCS file names as returned by `sampleNames(.gs)` below.

```{targets annots, tar_simple=TRUE}
.gs <- load_gs(params_path)
tibble(name = sampleNames(.gs)) %>% 
    mutate(Experiment = str_extract(name,"[0-9]{8}"),
           Experiment = factor(Experiment),
           Stimulation = str_extract(name,"(unstim|PMA Iono)_"),
           Stimulation = factor(Stimulation,
                                levels = c("unstim_","PMA Iono_"),
                                labels = c("unstim","PMA Iono")),
           Individual = str_extract(name,"(Amy|HC)[0-9]{1,2}"),
           Individual = factor(Individual))
```

# Marker annotation

Marker annotation uses the parameters identified above to identify channels that are important for the analysis; in particular *phenotypic* and *functional* markers will be used throughout. This is also an opportunity to clean up the `desc` field, returning human-readable channel names.

It's easier to get started from the file associated with the `GatingSet` being analyzed as shown below:

```{targets markers, tar_simple=TRUE}
.gs <- load_gs(params_path)
as_tibble(pData(parameters(gs_cyto_data(.gs)[[1]])),
          rownames = "id") %>% 
    mutate(desc = if_else(is.na(desc),
                          name,
                          desc),
           type = case_when(
               desc %in% params_ref_markers ~ "reference",
               desc %in% params_pheno_markers ~ "phenotypic",
               desc %in% params_func_markers ~ "functional",
               TRUE ~ "Other"),
           desc = make.names(desc),
           type = factor(type,
                         levels = c("reference","phenotypic","functional","Other")))
```

# Extract the data

To run the analysis we will need to access the expression values stored in the FCS files through the `exprs` command:

```{targets gs-to-tibble}
list(
    tar_target(live.mats,{
        .gs <- load_gs(params_path)
        .fs <- gs_pop_get_data(.gs,
                               params_population)
        fsApply(.fs,
                exprs,
                simplify = FALSE)
    }),
    tar_target(live.df,{
        bind_rows(lapply(live.mats,
                         as_tibble),
                  .id = "name")
    })
)
```

# Run the pipeline

```{r run}
tar_make()
```

# Quick overview

## Sample annotations

```{r}
tar_read(annots)
```

## Marker annotations

```{r}
tar_read(markers)
```

